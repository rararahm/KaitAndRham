<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Our Memory Journal</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #fff7f9;
				--panel: rgba(255, 255, 255, 0.85);
				--text: #2b2a2a;
				--muted: #7c6f7b;
				--accent: #f59ab8;
				--accent-strong: #e874a0;
				--border: rgba(242, 190, 204, 0.8);
				--shadow: 0 24px 60px rgba(232, 116, 160, 0.18);
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: "Playfair Display", "Times New Roman", serif;
				background: radial-gradient(circle at top, #fff1f5 0%, #fde8ef 40%, #fff 100%);
				color: var(--text);
				min-height: 100vh;
			}

			body::before {
				content: "";
				position: fixed;
				inset: 0;
				background-image:
					radial-gradient(circle at 20% 20%, rgba(245, 154, 184, 0.18), transparent 45%),
					radial-gradient(circle at 80% 10%, rgba(232, 116, 160, 0.16), transparent 50%),
					radial-gradient(circle at 70% 80%, rgba(250, 210, 224, 0.45), transparent 55%);
				z-index: -1;
			}

			header {
				padding: 48px 20px 12px;
				max-width: 1100px;
				margin: 0 auto;
				text-align: center;
			}

			h1 {
				font-size: 36px;
				letter-spacing: 0.5px;
				margin: 0 0 10px;
				font-weight: 600;
			}

			p {
				margin: 0 auto 16px;
				color: var(--muted);
				max-width: 620px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 15px;
			}

			.panel {
				max-width: 1100px;
				margin: 0 auto;
				padding: 20px 20px 60px;
			}

			.card {
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: 20px;
				padding: 20px;
				box-shadow: var(--shadow);
				backdrop-filter: blur(12px);
			}

			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
				gap: 16px;
			}

			label {
				display: block;
				font-size: 12px;
				color: var(--muted);
				margin-bottom: 6px;
				font-family: "Inter", "Segoe UI", sans-serif;
				letter-spacing: 0.3px;
				text-transform: uppercase;
			}

			input {
				width: 100%;
				padding: 11px 14px;
				border-radius: 14px;
				border: 1px solid var(--border);
				background: rgba(255, 255, 255, 0.8);
				color: var(--text);
				font-family: "Inter", "Segoe UI", sans-serif;
				box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
			}

			select {
				width: 100%;
				padding: 11px 14px;
				border-radius: 14px;
				border: 1px solid var(--border);
				background: rgba(255, 255, 255, 0.8);
				color: var(--text);
				font-family: "Inter", "Segoe UI", sans-serif;
				box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
			}

			.row {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 12px;
				margin-bottom: 12px;
			}

			.actions {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 8px;
				justify-content: center;
			}

			button {
				background: linear-gradient(135deg, var(--accent), var(--accent-strong));
				color: white;
				border: none;
				border-radius: 999px;
				padding: 10px 18px;
				font-weight: 600;
				cursor: pointer;
				font-family: "Inter", "Segoe UI", sans-serif;
				letter-spacing: 0.2px;
				box-shadow: 0 14px 26px rgba(232, 116, 160, 0.3);
			}

			button.secondary {
				background: rgba(255, 255, 255, 0.7);
				color: var(--text);
				border: 1px solid var(--border);
				box-shadow: none;
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.status {
				margin-top: 12px;
				font-size: 13px;
				color: var(--muted);
				text-align: center;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.gallery-item {
				background: white;
				border: 1px solid rgba(242, 190, 204, 0.6);
				border-radius: 18px;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				box-shadow: 0 18px 30px rgba(245, 154, 184, 0.18);
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			.gallery-item:hover {
				transform: translateY(-6px);
				box-shadow: 0 24px 36px rgba(245, 154, 184, 0.28);
			}

			.gallery-item img {
				width: 100%;
				height: 190px;
				object-fit: cover;
				display: block;
			}

			.gallery-item .meta {
				padding: 12px 14px 16px;
				display: grid;
				gap: 6px;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.gallery-item .name {
				font-size: 13px;
				color: var(--text);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.gallery-item a {
				font-size: 12px;
				color: var(--accent-strong);
				text-decoration: none;
			}

			.empty {
				text-align: center;
				color: var(--muted);
				padding: 30px 0;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.tagline {
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 14px;
				color: var(--muted);
				letter-spacing: 1.6px;
				text-transform: uppercase;
				margin-bottom: 6px;
			}

			.journal-note {
				margin: 18px auto 0;
				max-width: 720px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 14px;
				color: var(--muted);
			}

			.controls {
				display: none;
			}

			.sort-bar {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				align-items: end;
				margin-bottom: 14px;
			}

			.sort-bar .field {
				min-width: 220px;
				flex: 1;
			}

			.layout {
				display: grid;
				grid-template-columns: minmax(0, 1fr) 320px;
				gap: 18px;
				align-items: start;
			}

			.main-column {
				min-width: 0;
			}

			.side-column {
				min-width: 0;
			}

			.section-title {
				margin: 0 0 10px;
				font-size: 18px;
				letter-spacing: 0.4px;
				font-weight: 600;
			}

			.side-column .gallery-item img {
				height: 160px;
			}

			.side-column .grid {
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}

			.modal {
				position: fixed;
				inset: 0;
				display: none;
				align-items: center;
				justify-content: center;
				background: rgba(17, 14, 20, 0.65);
				backdrop-filter: blur(6px);
				z-index: 1000;
				padding: 24px;
			}

			.modal.open {
				display: flex;
			}

			.modal-content {
				max-width: min(100%, 980px);
				max-height: min(90vh, 820px);
				background: rgba(255, 255, 255, 0.96);
				border-radius: 22px;
				box-shadow: 0 28px 60px rgba(0, 0, 0, 0.25);
				overflow: hidden;
				position: relative;
			}

			.modal-content img {
				display: block;
				width: 100%;
				height: auto;
				max-height: 90vh;
				object-fit: contain;
				background: #fef7f9;
			}

			.modal-close {
				position: absolute;
				top: 12px;
				right: 12px;
				border: none;
				background: rgba(255, 255, 255, 0.9);
				width: 36px;
				height: 36px;
				border-radius: 50%;
				font-size: 20px;
				cursor: pointer;
				box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
			}

			.spotify-floating {
				position: fixed;
				right: 18px;
				bottom: 18px;
				width: 320px;
				height: 152px;
				border-radius: 18px;
				overflow: hidden;
				box-shadow: 0 18px 30px rgba(0, 0, 0, 0.2);
				z-index: 900;
				background: #fff;
			}

			.spotify-floating iframe {
				width: 100%;
				height: 100%;
				border: 0;
				display: block;
			}

			@media (max-width: 720px) {
				header {
					padding-top: 36px;
				}

				h1 {
					font-size: 30px;
				}

				.layout {
					grid-template-columns: 1fr;
					gap: 14px;
				}

				.panel {
					padding: 16px 16px 48px;
				}

				.card {
					padding: 16px;
				}

				.grid {
					grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
					gap: 12px;
				}

				.gallery-item img {
					height: 160px;
				}

				.side-column .grid {
					grid-template-columns: repeat(2, minmax(0, 1fr));
				}

				.sort-bar {
					margin-bottom: 12px;
				}

				.modal {
					padding: 12px;
				}

				.modal-content {
					border-radius: 16px;
				}

				.modal-close {
					width: 32px;
					height: 32px;
					font-size: 18px;
				}

				.spotify-floating {
					left: 12px;
					right: 12px;
					bottom: 12px;
					width: auto;
					height: 152px;
				}
			}
		</style>
		<script src="https://apis.google.com/js/api.js"></script>
	</head>
	<body>
		<header>
			<div class="tagline">Our Story</div>
			<h1>Our Memory Journal</h1>
			<p>A safe space for our moments together.</p>
		</header>

		<main class="panel">
			<section class="card controls" aria-hidden="true">
				<div class="row">
					<div>
						<label for="apiKey">API Key</label>
						<input id="apiKey" type="text" placeholder="AIza..." />
					</div>
					<div>
						<label for="clientId">OAuth Client ID (required for private)</label>
						<input id="clientId" type="text" placeholder="xxxxx.apps.googleusercontent.com" />
					</div>
					<div>
						<label for="folderId">Folder ID (optional)</label>
						<input id="folderId" type="text" placeholder="Drive folder ID" value="1G2f2Nbeadv9v3_SW3ONLhjqIzDkz84vs" />
					</div>
					<div>
						<label for="pageSize">Max results</label>
						<input id="pageSize" type="number" min="1" max="500" value="100" />
					</div>
				</div>
				<div class="actions">
					<button id="connectBtn">Connect & Load Images</button>
					<button id="publicBtn" class="secondary">Load Public Folder</button>
					<button id="refreshBtn" class="secondary" disabled>Refresh</button>
					<button id="signOutBtn" class="secondary" disabled>Sign Out</button>
				</div>
				<div class="status" id="status">Not connected.</div>
			</section>

			<div class="layout" style="margin-top: 16px;">
				<section class="card main-column">
					<div class="sort-bar">
						<div class="field">
							<label for="sortOrder">Sort by</label>
							<select id="sortOrder">
								<option value="modifiedTime desc" selected>Newest updates first</option>
								<option value="modifiedTime asc">Oldest updates first</option>
								<option value="createdTime desc">Newest uploads first</option>
								<option value="createdTime asc">Oldest uploads first</option>
								<option value="name asc">Name A → Z</option>
								<option value="name desc">Name Z → A</option>
							</select>
						</div>
					</div>
					<div id="gallery" class="grid"></div>
					<div id="emptyState" class="empty" hidden>No images found.</div>
				</section>
				<section class="card side-column">
					<h2 class="section-title">Rham's Favorites</h2>
					<div id="gallerySecondary" class="grid"></div>
					<div id="emptyStateSecondary" class="empty" hidden>No images found.</div>
				</section>
			</div>
		</main>

		<div class="modal" id="imageModal" aria-hidden="true">
			<div class="modal-content" role="dialog" aria-modal="true" aria-label="Image preview">
				<button class="modal-close" id="modalClose" aria-label="Close">×</button>
				<img id="modalImage" alt="Selected memory" />
			</div>
		</div>

		<div class="spotify-floating" aria-label="Spotify playlist">
			<iframe
				src="https://open.spotify.com/embed/playlist/36dQ7Sdck17FTGjA5yfBAf?utm_source=generator"
				allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
				loading="lazy"
			></iframe>
		</div>

		<script>
			const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
			const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
			const DEFAULT_API_KEY = "AIzaSyCbqmjlzJulYTP5zBuA_Qm8nbnnM7sRVio";
			const SECONDARY_FOLDER_ID = "13N949T2B3LnTsyAvhFsiAX6UitweJxjh";

			const apiKeyInput = document.getElementById("apiKey");
			const clientIdInput = document.getElementById("clientId");
			const folderIdInput = document.getElementById("folderId");
			const pageSizeInput = document.getElementById("pageSize");
			const connectBtn = document.getElementById("connectBtn");
			const publicBtn = document.getElementById("publicBtn");
			const refreshBtn = document.getElementById("refreshBtn");
			const signOutBtn = document.getElementById("signOutBtn");
			const statusEl = document.getElementById("status");
			const galleryEl = document.getElementById("gallery");
			const emptyStateEl = document.getElementById("emptyState");
			const gallerySecondaryEl = document.getElementById("gallerySecondary");
			const emptyStateSecondaryEl = document.getElementById("emptyStateSecondary");
			const sortOrderSelect = document.getElementById("sortOrder");
			const imageModal = document.getElementById("imageModal");
			const modalImage = document.getElementById("modalImage");
			const modalClose = document.getElementById("modalClose");

			let isInitialized = false;
			let isAuthorized = false;

			if (DEFAULT_API_KEY) {
				apiKeyInput.value = DEFAULT_API_KEY;
			}

			function setStatus(message) {
				statusEl.textContent = message;
			}

			function setButtons() {
				refreshBtn.disabled = !isAuthorized;
				signOutBtn.disabled = !isAuthorized;
			}

			function clearGallery() {
				galleryEl.innerHTML = "";
				emptyStateEl.hidden = true;
			}

			function clearSecondaryGallery() {
				gallerySecondaryEl.innerHTML = "";
				emptyStateSecondaryEl.hidden = true;
			}

			function showEmptyState(show) {
				emptyStateEl.hidden = !show;
			}

			function showSecondaryEmptyState(show) {
				emptyStateSecondaryEl.hidden = !show;
			}

			function renderFiles(files, targetEl) {
				files.forEach((file) => {
					const item = document.createElement("div");
					item.className = "gallery-item";

					const img = document.createElement("img");
					if (file.thumbnailLink) {
						img.src = file.thumbnailLink.replace("=s220", "=s640");
						img.dataset.full = file.thumbnailLink.replace(/=s\d+/, "=s1600");
					} else {
						img.alt = "No preview available";
						img.dataset.full = file.webViewLink;
					}

					const meta = document.createElement("div");
					meta.className = "meta";

					const name = document.createElement("div");
					name.className = "name";
					name.textContent = file.name;

					const link = document.createElement("a");
					link.href = file.webViewLink;
					link.target = "_blank";
					link.rel = "noopener";
					link.textContent = "Open in Drive";

					meta.appendChild(name);
					meta.appendChild(link);
					item.appendChild(img);
					item.appendChild(meta);
					targetEl.appendChild(item);
				});
			}

			function openModal(src) {
				modalImage.src = src;
				imageModal.classList.add("open");
				imageModal.setAttribute("aria-hidden", "false");
			}

			function closeModal() {
				imageModal.classList.remove("open");
				imageModal.setAttribute("aria-hidden", "true");
				modalImage.src = "";
			}

			async function fetchDriveImages({ apiKey, folderId, pageSize, orderBy }) {
				const baseQuery = "mimeType contains 'image/' and trashed = false";
				const q = `'${folderId}' in parents and ${baseQuery}`;
				const params = new URLSearchParams({
					q,
					pageSize: String(pageSize),
					fields: "files(id,name,mimeType,thumbnailLink,webViewLink)",
					orderBy,
					key: apiKey,
				});

				const response = await fetch(`https://www.googleapis.com/drive/v3/files?${params.toString()}`);
				if (!response.ok) {
					const errorBody = await response.json().catch(() => ({}));
					throw new Error(errorBody?.error?.message || "Failed to load folder.");
				}
				const data = await response.json();
				return data.files || [];
			}

			function debounce(fn, delay) {
				let timer;
				return (...args) => {
					window.clearTimeout(timer);
					timer = window.setTimeout(() => fn(...args), delay);
				};
			}

			async function initClient() {
				const apiKey = apiKeyInput.value.trim();
				const clientId = clientIdInput.value.trim();

				if (!apiKey || !clientId) {
					setStatus("Please provide both API Key and OAuth Client ID for private Drive access.");
					return;
				}

				setStatus("Initializing Google API client...");

				await gapi.client.init({
					apiKey,
					clientId,
					discoveryDocs: DISCOVERY_DOCS,
					scope: SCOPES,
				});

				isInitialized = true;
				const authInstance = gapi.auth2.getAuthInstance();
				authInstance.isSignedIn.listen(updateSigninStatus);
				updateSigninStatus(authInstance.isSignedIn.get());
			}

			function updateSigninStatus(signedIn) {
				isAuthorized = signedIn;
				setButtons();
				if (signedIn) {
					setStatus("Connected. Loading images...");
					listImages();
				} else {
					setStatus("Not connected.");
					clearGallery();
				}
			}

			async function handleConnect() {
				try {
					if (!isInitialized) {
						await new Promise((resolve, reject) => {
							gapi.load("client:auth2", {
								callback: resolve,
								onerror: () => reject(new Error("Failed to load Google API.")),
							});
						});
						await initClient();
					}

					const authInstance = gapi.auth2.getAuthInstance();
					if (!authInstance.isSignedIn.get()) {
						setStatus("Opening sign-in window...");
						await authInstance.signIn();
					} else {
						listImages();
					}
				} catch (error) {
					setStatus(`Error: ${error.message}`);
				}
			}

			async function handlePublicLoad() {
				const apiKey = (apiKeyInput.value.trim() || DEFAULT_API_KEY).trim();
				const folderId = folderIdInput.value.trim();
				if (!apiKey || !folderId) {
					setStatus("Provide API Key and Folder ID to load a public folder.");
					return;
				}

				clearGallery();
				clearSecondaryGallery();
				setStatus("Fetching public folder images...");

				const pageSize = Math.max(1, Math.min(500, Number(pageSizeInput.value) || 100));

				try {
					const [mainFiles, secondaryFiles] = await Promise.all([
						fetchDriveImages({
							apiKey,
							folderId,
							pageSize,
							orderBy: sortOrderSelect.value,
						}),
						fetchDriveImages({
							apiKey,
							folderId: SECONDARY_FOLDER_ID,
							pageSize,
							orderBy: sortOrderSelect.value,
						}),
					]);

					if (!mainFiles.length) {
						showEmptyState(true);
					}
					if (!secondaryFiles.length) {
						showSecondaryEmptyState(true);
					}

					renderFiles(mainFiles, galleryEl);
					renderFiles(secondaryFiles, gallerySecondaryEl);

					setStatus(`Loaded ${mainFiles.length} main image(s) and ${secondaryFiles.length} from Rham's Faves.`);
				} catch (error) {
					setStatus(`Error fetching public images: ${error.message}`);
				}
			}

			async function handleSignOut() {
				const authInstance = gapi.auth2.getAuthInstance();
				await authInstance.signOut();
				updateSigninStatus(false);
			}

			async function listImages() {
				if (!isAuthorized) {
					return;
				}

				clearGallery();
				setStatus("Fetching images...");

				const folderId = folderIdInput.value.trim();
				const pageSize = Math.max(1, Math.min(500, Number(pageSizeInput.value) || 100));

				const baseQuery = "mimeType contains 'image/' and trashed = false";
				const q = folderId ? `'${folderId}' in parents and ${baseQuery}` : baseQuery;

				try {
					const response = await gapi.client.drive.files.list({
						q,
						pageSize,
						fields: "files(id,name,mimeType,thumbnailLink,webViewLink)",
						orderBy: sortOrderSelect.value,
					});

					const files = response.result.files || [];
					if (!files.length) {
						showEmptyState(true);
						setStatus("No images found.");
						return;
					}

					files.forEach((file) => {
						const item = document.createElement("div");
						item.className = "gallery-item";

						const img = document.createElement("img");
						if (file.thumbnailLink) {
							img.src = file.thumbnailLink.replace("=s220", "=s640");
						} else {
							img.alt = "No preview available";
						}

						const meta = document.createElement("div");
						meta.className = "meta";

						const name = document.createElement("div");
						name.className = "name";
						name.textContent = file.name;

						const link = document.createElement("a");
						link.href = file.webViewLink;
						link.target = "_blank";
						link.rel = "noopener";
						link.textContent = "Open in Drive";

						meta.appendChild(name);
						meta.appendChild(link);
						item.appendChild(img);
						item.appendChild(meta);
						galleryEl.appendChild(item);
					});

					setStatus(`Loaded ${files.length} image(s).`);
				} catch (error) {
					setStatus(`Error fetching images: ${error.message}`);
				}
			}

			const autoLoadPublic = debounce(() => {
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				}
			}, 600);

			connectBtn.addEventListener("click", handleConnect);
			publicBtn.addEventListener("click", handlePublicLoad);
			refreshBtn.addEventListener("click", listImages);
			signOutBtn.addEventListener("click", handleSignOut);
			apiKeyInput.addEventListener("input", autoLoadPublic);
			sortOrderSelect.addEventListener("change", () => {
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				} else if (isAuthorized) {
					listImages();
				}
			});

			window.addEventListener("load", () => {
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				}
			});

			[galleryEl, gallerySecondaryEl].forEach((gallery) => {
				gallery.addEventListener("click", (event) => {
					const img = event.target.closest("img");
					if (!img || !img.dataset.full) {
						return;
					}
					openModal(img.dataset.full);
				});
			});

			modalClose.addEventListener("click", closeModal);
			imageModal.addEventListener("click", (event) => {
				if (event.target === imageModal) {
					closeModal();
				}
			});

			window.addEventListener("keydown", (event) => {
				if (event.key === "Escape") {
					closeModal();
				}
			});
		</script>
	</body>
</html>
