<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Our Memory Journal</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #fff7f9;
				--panel: rgba(255, 255, 255, 0.85);
				--text: #2b2a2a;
				--muted: #7c6f7b;
				--accent: #f59ab8;
				--accent-strong: #e874a0;
				--border: rgba(242, 190, 204, 0.8);
				--shadow: 0 24px 60px rgba(232, 116, 160, 0.18);
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: "Playfair Display", "Times New Roman", serif;
				background: radial-gradient(circle at top, #fff1f5 0%, #fde8ef 40%, #fff 100%);
				color: var(--text);
				min-height: 100vh;
				padding-top: 72px;
			}

			body::before {
				content: "";
				position: fixed;
				inset: 0;
				background-image:
					radial-gradient(circle at 20% 20%, rgba(245, 154, 184, 0.18), transparent 45%),
					radial-gradient(circle at 80% 10%, rgba(232, 116, 160, 0.16), transparent 50%),
					radial-gradient(circle at 70% 80%, rgba(250, 210, 224, 0.45), transparent 55%);
				z-index: -1;
			}

			header {
				padding: 48px 20px 12px;
				max-width: 1100px;
				margin: 0 auto;
				text-align: center;
			}

			h1 {
				font-size: 36px;
				letter-spacing: 0.5px;
				margin: 0 0 10px;
				font-weight: 600;
			}

			p {
				margin: 0 auto 16px;
				color: var(--muted);
				max-width: 620px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 15px;
			}

			.panel {
				max-width: 1100px;
				margin: 0 auto;
				padding: 20px 20px 60px;
			}

			.card {
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: 20px;
				padding: 20px;
				box-shadow: var(--shadow);
				backdrop-filter: blur(12px);
			}

			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
				gap: 16px;
			}

			label {
				display: block;
				font-size: 12px;
				color: var(--muted);
				margin-bottom: 6px;
				font-family: "Inter", "Segoe UI", sans-serif;
				letter-spacing: 0.3px;
				text-transform: uppercase;
			}

			input {
				width: 100%;
				padding: 11px 14px;
				border-radius: 14px;
				border: 1px solid var(--border);
				background: rgba(255, 255, 255, 0.8);
				color: var(--text);
				font-family: "Inter", "Segoe UI", sans-serif;
				box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
			}

			select {
				width: 100%;
				padding: 11px 14px;
				border-radius: 14px;
				border: 1px solid var(--border);
				background: rgba(255, 255, 255, 0.8);
				color: var(--text);
				font-family: "Inter", "Segoe UI", sans-serif;
				box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
			}

			.row {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 12px;
				margin-bottom: 12px;
			}

			.actions {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 8px;
				justify-content: center;
			}

			button {
				background: linear-gradient(135deg, var(--accent), var(--accent-strong));
				color: white;
				border: none;
				border-radius: 999px;
				padding: 10px 18px;
				font-weight: 600;
				cursor: pointer;
				font-family: "Inter", "Segoe UI", sans-serif;
				letter-spacing: 0.2px;
				box-shadow: 0 14px 26px rgba(232, 116, 160, 0.3);
			}

			button.secondary {
				background: rgba(255, 255, 255, 0.7);
				color: var(--text);
				border: 1px solid var(--border);
				box-shadow: none;
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.status {
				margin-top: 12px;
				font-size: 13px;
				color: var(--muted);
				text-align: center;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.gallery-item {
				background: white;
				border: 1px solid rgba(242, 190, 204, 0.6);
				border-radius: 18px;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				box-shadow: 0 18px 30px rgba(245, 154, 184, 0.18);
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			.gallery-item:hover {
				transform: translateY(-6px);
				box-shadow: 0 24px 36px rgba(245, 154, 184, 0.28);
			}

			.gallery-item img {
				width: 100%;
				height: 190px;
				object-fit: cover;
				display: block;
			}

			.gallery-item .meta {
				padding: 12px 14px 16px;
				display: grid;
				gap: 6px;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.gallery-item .name {
				font-size: 13px;
				color: var(--text);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.gallery-item a {
				font-size: 12px;
				color: var(--accent-strong);
				text-decoration: none;
			}

			.empty {
				text-align: center;
				color: var(--muted);
				padding: 30px 0;
				font-family: "Inter", "Segoe UI", sans-serif;
			}

			.tagline {
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 14px;
				color: var(--muted);
				letter-spacing: 1.6px;
				text-transform: uppercase;
				margin-bottom: 6px;
			}

			.top-nav {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				z-index: 800;
			}

			.nav-inner {
				max-width: 1100px;
				margin: 0 auto;
				padding: 12px 20px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
			}

			.nav-title {
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 13px;
				letter-spacing: 1.8px;
				text-transform: uppercase;
				color: var(--muted);
			}

			.nav-links {
				display: inline-flex;
				gap: 10px;
				padding: 6px;
				border-radius: 999px;
				background: rgba(255, 255, 255, 0.75);
				border: 1px solid rgba(232, 116, 160, 0.25);
				box-shadow: 0 10px 20px rgba(232, 116, 160, 0.15);
			}

			.nav-link {
				text-decoration: none;
				padding: 8px 16px;
				border-radius: 999px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 13px;
				font-weight: 600;
				color: var(--muted);
				display: inline-flex;
				align-items: center;
				gap: 6px;
				transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
			}

			.nav-link:active {
				transform: scale(0.96);
			}

			.nav-link.active {
				background: linear-gradient(135deg, var(--accent), var(--accent-strong));
				color: white;
				box-shadow: 0 12px 20px rgba(232, 116, 160, 0.3);
			}

			.love-counter {
				margin: 6px auto 14px;
				display: inline-flex;
				align-items: center;
				gap: 10px;
				padding: 8px 16px;
				border-radius: 999px;
				background: rgba(255, 255, 255, 0.75);
				border: 1px solid rgba(232, 116, 160, 0.35);
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 13px;
				color: var(--text);
				box-shadow: 0 10px 20px rgba(232, 116, 160, 0.18);
			}

			.love-counter strong {
				font-weight: 600;
				letter-spacing: 0.3px;
			}

			.love-counter span {
				color: var(--muted);
				letter-spacing: 0.2px;
			}

			.journal-note {
				margin: 18px auto 0;
				max-width: 720px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 14px;
				color: var(--muted);
			}

			.controls {
				display: none;
			}

			.today-highlights {
				margin: 0 auto 20px;
				max-width: 1100px;
				overflow: hidden;
			}

			.highlights-title {
				text-align: center;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 13px;
				font-weight: 600;
				color: var(--muted);
				letter-spacing: 1.4px;
				text-transform: uppercase;
				margin-bottom: 12px;
			}

			.marquee-container {
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: 16px;
				overflow: hidden;
				box-shadow: 0 12px 24px rgba(245, 154, 184, 0.12);
				backdrop-filter: blur(12px);
				position: relative;
			}

			.marquee-container::before,
			.marquee-container::after {
				content: "";
				position: absolute;
				top: 0;
				bottom: 0;
				width: 60px;
				z-index: 2;
				pointer-events: none;
			}

			.marquee-container::before {
				left: 0;
				background: linear-gradient(90deg, rgba(255, 247, 249, 1), rgba(255, 247, 249, 0));
			}

			.marquee-container::after {
				right: 0;
				background: linear-gradient(270deg, rgba(255, 247, 249, 1), rgba(255, 247, 249, 0));
			}

			.marquee {
				display: flex;
				gap: 12px;
				padding: 12px;
				will-change: transform;
				transform: translateX(0);
			}

			.marquee:hover {
				animation-play-state: paused;
			}

			@keyframes marquee {
				0% {
					transform: translateX(0);
				}
				100% {
					transform: translateX(-50%);
				}
			}

			.marquee-item {
				flex-shrink: 0;
				width: 200px;
				height: 150px;
				border-radius: 12px;
				overflow: hidden;
				cursor: pointer;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
				border: 1px solid rgba(232, 116, 160, 0.2);
			}

			.marquee-item:hover {
				transform: scale(1.05);
				box-shadow: 0 8px 16px rgba(232, 116, 160, 0.25);
			}

			.sort-bar {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				align-items: end;
				margin-bottom: 14px;
			}

			.sort-bar .field {
				min-width: 220px;
				flex: 1;
			}

			.layout {
				display: grid;
				grid-template-columns: minmax(0, 1fr) 320px;
				gap: 18px;
				align-items: start;
			}

			.main-column {
				min-width: 0;
			}

			.side-column {
				min-width: 0;
			}

			.section-title {
				margin: 0 0 10px;
				font-size: 18px;
				letter-spacing: 0.4px;
				font-weight: 600;
			}

			.side-column .gallery-item img {
				height: 160px;
			}

			.side-column .grid {
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}

			.tabs {
				display: inline-flex;
				gap: 10px;
				padding: 6px;
				border-radius: 999px;
				background: rgba(255, 255, 255, 0.75);
				border: 1px solid rgba(232, 116, 160, 0.25);
				box-shadow: 0 10px 20px rgba(232, 116, 160, 0.15);
				margin: 10px auto 0;
			}

			.tab-button {
				border: none;
				background: transparent;
				padding: 8px 16px;
				border-radius: 999px;
				font-family: "Inter", "Segoe UI", sans-serif;
				font-size: 13px;
				font-weight: 600;
				color: var(--muted);
				cursor: pointer;
			}

			.tab-button.active {
				background: linear-gradient(135deg, var(--accent), var(--accent-strong));
				color: white;
				box-shadow: 0 12px 20px rgba(232, 116, 160, 0.3);
			}

			.tab-panel {
				display: none;
			}

			.tab-panel.active {
				display: block;
			}

			.photobooth-layout {
				display: grid;
				grid-template-columns: minmax(0, 1fr) 360px;
				gap: 18px;
				align-items: start;
			}

			.photobooth-list {
				max-height: 520px;
				overflow: auto;
				padding-right: 4px;
			}

			.photo-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
				gap: 10px;
			}

			.photo-option {
				position: relative;
				border-radius: 14px;
				overflow: hidden;
				border: 1px solid rgba(242, 190, 204, 0.6);
				background: white;
				cursor: pointer;
				transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
			}

			.photo-option img {
				display: block;
				width: 100%;
				height: 120px;
				object-fit: cover;
			}

			.photo-option.selected {
				border-color: var(--accent-strong);
				box-shadow: 0 12px 20px rgba(232, 116, 160, 0.2);
				transform: translateY(-2px);
			}

			.photo-option input {
				position: absolute;
				opacity: 0;
				pointer-events: none;
			}

			.photobooth-preview {
				display: grid;
				gap: 12px;
			}

			.collage-frame {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 18px;
				border: 1px solid rgba(242, 190, 204, 0.6);
				padding: 12px;
				box-shadow: 0 14px 28px rgba(232, 116, 160, 0.15);
			}

			.collage-frame canvas {
				width: 100%;
				height: auto;
				display: block;
				border-radius: 12px;
				background: #fff;
			}

			.booth-actions {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}

			.modal {
				position: fixed;
				inset: 0;
				display: none;
				align-items: center;
				justify-content: center;
				background: rgba(17, 14, 20, 0.65);
				backdrop-filter: blur(6px);
				z-index: 1000;
				padding: 24px;
			}

			.modal.open {
				display: flex;
			}

			.modal-content {
				max-width: min(100%, 980px);
				max-height: min(90vh, 820px);
				background: rgba(255, 255, 255, 0.96);
				border-radius: 22px;
				box-shadow: 0 28px 60px rgba(0, 0, 0, 0.25);
				overflow: hidden;
				position: relative;
			}

			.modal-content img {
				display: block;
				width: 100%;
				height: auto;
				max-height: 90vh;
				object-fit: contain;
				background: #fef7f9;
			}

			.modal-close {
				position: absolute;
				top: 12px;
				right: 12px;
				border: none;
				background: rgba(255, 255, 255, 0.9);
				width: 36px;
				height: 36px;
				border-radius: 50%;
				font-size: 20px;
				cursor: pointer;
				box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
			}

			.spotify-floating {
				position: fixed;
				right: 18px;
				bottom: 18px;
				width: 320px;
				height: 152px;
				border-radius: 18px;
				overflow: hidden;
				box-shadow: 0 18px 30px rgba(0, 0, 0, 0.2);
				z-index: 900;
				background: #fff;
			}

			.spotify-floating iframe {
				width: 100%;
				height: 100%;
				border: 0;
				display: block;
			}

			@media (max-width: 720px) {
				body {
					padding-top: 92px;
				}

				.nav-inner {
					flex-direction: column;
					align-items: center;
				}

				.nav-links {
					width: 100%;
					justify-content: center;
				}
				header {
					padding-top: 36px;
				}

				h1 {
					font-size: 30px;
				}

				.layout {
					grid-template-columns: 1fr;
					gap: 14px;
				}

				.love-counter {
					font-size: 12px;
					padding: 8px 12px;
					gap: 8px;
				}

				.panel {
					padding: 16px 16px 48px;
				}

				.card {
					padding: 16px;
				}

				.grid {
					grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
					gap: 12px;
				}

				.gallery-item img {
					height: 160px;
				}

				.side-column .grid {
					grid-template-columns: repeat(2, minmax(0, 1fr));
				}

				.sort-bar {
					margin-bottom: 12px;
				}

				.modal {
					padding: 12px;
				}

				.modal-content {
					border-radius: 16px;
				}

				.modal-close {
					width: 32px;
					height: 32px;
					font-size: 18px;
				}

				.spotify-floating {
					left: 12px;
					right: 12px;
					bottom: 12px;
					width: auto;
					height: 152px;
				}

				.tabs {
					width: 100%;
					justify-content: center;
				}

				.photobooth-layout {
					grid-template-columns: 1fr;
				}

				.photo-grid {
					grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
				}

				.photo-option img {
					height: 100px;
				}
			}
		</style>
		<script src="https://apis.google.com/js/api.js"></script>
	</head>
	<body>
		<nav class="top-nav">
			<div class="nav-inner">
				<div class="nav-title"></div>
				<div class="nav-links" aria-label="Pages">
					<a class="nav-link active" href="index.html">Home</a>
					<a class="nav-link" href="photobooth.html">PhotoBooth</a>
				</div>
			</div>
		</nav>
		<header>
			<div class="tagline">Our Story</div>
			<div class="love-counter" aria-live="polite">
				<strong>Loving you for</strong>
				<span id="loveCounter">Loading...</span>
			</div>
			<h1>Our Memory Journal</h1>
			<p>A safe space for our moments together.</p>
			<div class="today-highlights">
				<div class="highlights-title">Today's Highlights</div>
				<div class="marquee-container">
					<div class="marquee" id="marquee"></div>
				</div>
			</div>
		</header>

		<main class="panel">
			<section class="tab-panel active" id="tab-home" role="tabpanel">
				<section class="card controls" aria-hidden="true">
					<div class="row">
						<div>
							<label for="apiKey">API Key</label>
							<input id="apiKey" type="text" placeholder="AIza..." />
						</div>
						<div>
							<label for="clientId">OAuth Client ID (required for private)</label>
							<input id="clientId" type="text" placeholder="xxxxx.apps.googleusercontent.com" />
						</div>
						<div>
							<label for="folderId">Folder ID (optional)</label>
							<input id="folderId" type="text" placeholder="Drive folder ID" value="1G2f2Nbeadv9v3_SW3ONLhjqIzDkz84vs" />
						</div>
						<div>
							<label for="pageSize">Max results</label>
							<input id="pageSize" type="number" min="1" max="500" value="100" />
						</div>
					</div>
					<div class="actions">
						<button id="connectBtn">Connect & Load Images</button>
						<button id="publicBtn" class="secondary">Load Public Folder</button>
						<button id="refreshBtn" class="secondary" disabled>Refresh</button>
						<button id="signOutBtn" class="secondary" disabled>Sign Out</button>
					</div>
					<div class="status" id="status">Not connected.</div>
				</section>

				<div class="layout" style="margin-top: 16px;">
					<section class="card main-column">
						<div class="sort-bar">
							<div class="field">
								<label for="sortOrder">Sort by</label>
								<select id="sortOrder">
									<option value="modifiedTime desc" selected>Newest updates first</option>
									<option value="modifiedTime asc">Oldest updates first</option>
									<option value="createdTime desc">Newest uploads first</option>
									<option value="createdTime asc">Oldest uploads first</option>
									<option value="name asc">Name A → Z</option>
									<option value="name desc">Name Z → A</option>
								</select>
							</div>
						</div>
						<div id="gallery" class="grid"></div>
						<div id="emptyState" class="empty" hidden>No images found.</div>
					</section>
					<section class="card side-column">
						<h2 class="section-title">Rham's Favorites</h2>
						<div id="gallerySecondary" class="grid"></div>
						<div id="emptyStateSecondary" class="empty" hidden>No images found.</div>
					</section>
				</div>
			</section>

			<section class="tab-panel" id="tab-photobooth" role="tabpanel">
				<div class="photobooth-layout" style="margin-top: 16px;">
					<section class="card">
						<h2 class="section-title">PhotoBooth</h2>
						<p>Select up to 9 photos from your drives to build a collage.</p>
						<div class="photobooth-list">
							<div id="photoboothGrid" class="photo-grid"></div>
						</div>
						<div class="status" id="boothStatus">Choose your favorites to start.</div>
					</section>
					<section class="card photobooth-preview">
						<h2 class="section-title">Collage Preview</h2>
						<div class="collage-frame">
							<canvas id="collageCanvas" width="1200" height="1200"></canvas>
						</div>
						<div class="booth-actions">
							<button id="downloadCollage">Download collage</button>
							<button id="clearSelection" class="secondary" type="button">Clear selection</button>
						</div>
					</section>
				</div>
			</section>
		</main>

		<div class="modal" id="imageModal" aria-hidden="true">
			<div class="modal-content" role="dialog" aria-modal="true" aria-label="Image preview">
				<button class="modal-close" id="modalClose" aria-label="Close">×</button>
				<img id="modalImage" alt="Selected memory" />
			</div>
		</div>

		<div class="spotify-floating" aria-label="Spotify playlist">
			<iframe
				src="https://open.spotify.com/embed/playlist/36dQ7Sdck17FTGjA5yfBAf?utm_source=generator"
				allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
				loading="lazy"
			></iframe>
		</div>

		<script>
			const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
			const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
			const DEFAULT_API_KEY = "AIzaSyCbqmjlzJulYTP5zBuA_Qm8nbnnM7sRVio";
			const SECONDARY_FOLDER_ID = "13N949T2B3LnTsyAvhFsiAX6UitweJxjh";

			const apiKeyInput = document.getElementById("apiKey");
			const clientIdInput = document.getElementById("clientId");
			const folderIdInput = document.getElementById("folderId");
			const pageSizeInput = document.getElementById("pageSize");
			const connectBtn = document.getElementById("connectBtn");
			const publicBtn = document.getElementById("publicBtn");
			const refreshBtn = document.getElementById("refreshBtn");
			const signOutBtn = document.getElementById("signOutBtn");
			const statusEl = document.getElementById("status");
			const galleryEl = document.getElementById("gallery");
			const emptyStateEl = document.getElementById("emptyState");
			const gallerySecondaryEl = document.getElementById("gallerySecondary");
			const emptyStateSecondaryEl = document.getElementById("emptyStateSecondary");
			const sortOrderSelect = document.getElementById("sortOrder");
			const imageModal = document.getElementById("imageModal");
			const modalImage = document.getElementById("modalImage");
			const modalClose = document.getElementById("modalClose");
			const loveCounterEl = document.getElementById("loveCounter");
			const marqueeEl = document.getElementById("marquee");

			let isInitialized = false;
			let isAuthorized = false;

			if (DEFAULT_API_KEY) {
				apiKeyInput.value = DEFAULT_API_KEY;
			}

			function setStatus(message) {
				statusEl.textContent = message;
			}

			function setButtons() {
				refreshBtn.disabled = !isAuthorized;
				signOutBtn.disabled = !isAuthorized;
			}

			function clearGallery() {
				galleryEl.innerHTML = "";
				emptyStateEl.hidden = true;
			}

			function clearSecondaryGallery() {
				gallerySecondaryEl.innerHTML = "";
				emptyStateSecondaryEl.hidden = true;
			}

			function showEmptyState(show) {
				emptyStateEl.hidden = !show;
			}

			function showSecondaryEmptyState(show) {
				emptyStateSecondaryEl.hidden = !show;
			}

			function renderFiles(files, targetEl) {
				files.forEach((file) => {
					const item = document.createElement("div");
					item.className = "gallery-item";

					const img = document.createElement("img");
					if (file.thumbnailLink) {
						img.src = file.thumbnailLink.replace("=s220", "=s640");
						img.dataset.full = file.thumbnailLink.replace(/=s\d+/, "=s1600");
					} else {
						img.alt = "No preview available";
						img.dataset.full = file.webViewLink;
					}

					const meta = document.createElement("div");
					meta.className = "meta";

					const name = document.createElement("div");
					name.className = "name";
					name.textContent = file.name;

					const link = document.createElement("a");
					link.href = file.webViewLink;
					link.target = "_blank";
					link.rel = "noopener";
					link.textContent = "Open in Drive";

					meta.appendChild(name);
					meta.appendChild(link);
					item.appendChild(img);
					item.appendChild(meta);
					targetEl.appendChild(item);
				});
			}

			function openModal(src) {
				modalImage.src = src;
				imageModal.classList.add("open");
				imageModal.setAttribute("aria-hidden", "false");
			}

			function closeModal() {
				imageModal.classList.remove("open");
				imageModal.setAttribute("aria-hidden", "true");
				modalImage.src = "";
			}

			function updateLoveCounter() {
				const start = new Date(2022, 11, 8, 0, 0, 0);
				const now = new Date();
				if (now <= start) {
					loveCounterEl.textContent = "0y 0m 0d 0h 0m 0s";
					return;
				}

				let years = now.getFullYear() - start.getFullYear();
				let months = now.getMonth() - start.getMonth();
				let days = now.getDate() - start.getDate();
				let hours = now.getHours() - start.getHours();
				let minutes = now.getMinutes() - start.getMinutes();
				let seconds = now.getSeconds() - start.getSeconds();

				if (seconds < 0) {
					seconds += 60;
					minutes -= 1;
				}

				if (minutes < 0) {
					minutes += 60;
					hours -= 1;
				}

				if (hours < 0) {
					hours += 24;
					days -= 1;
				}

				if (days < 0) {
					months -= 1;
					const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
					days += prevMonth.getDate();
				}

				if (months < 0) {
					months += 12;
					years -= 1;
				}

				const parts = [
					`${years}y`,
					`${months}m`,
					`${days}d`,
					`${hours}h`,
					`${minutes}m`,
					`${seconds}s`,
				];
				loveCounterEl.textContent = parts.join(" ");
			}

			async function fetchDriveImages({ apiKey, folderId, pageSize, orderBy }) {
				const baseQuery = "mimeType contains 'image/' and trashed = false";
				const q = `'${folderId}' in parents and ${baseQuery}`;
				const params = new URLSearchParams({
					q,
					pageSize: String(pageSize),
					fields: "files(id,name,mimeType,thumbnailLink,webViewLink,createdTime)",
					orderBy,
					key: apiKey,
				});

				const response = await fetch(`https://www.googleapis.com/drive/v3/files?${params.toString()}`);
				if (!response.ok) {
					const errorBody = await response.json().catch(() => ({}));
					throw new Error(errorBody?.error?.message || "Failed to load folder.");
				}
				const data = await response.json();
				return data.files || [];
			}

			function isToday(dateString) {
				if (!dateString) return false;
				const fileDate = new Date(dateString);
				const today = new Date();
				return fileDate.toDateString() === today.toDateString();
			}

			function buildSizedImageUrl(link, size) {
				if (!link) {
					return "";
				}
				if (/=s\d+/.test(link)) {
					return link.replace(/=s\d+/, `=s${size}`);
				}
				return `${link}=s${size}`;
			}

			function getImageTransform(fileId) {
				const stored = localStorage.getItem(`img-transform-${fileId}`);
				return stored ? JSON.parse(stored) : { rotate: 0, flipX: false };
			}

			function drawImageWithTransform(canvas, sourceImg, width, height, transform) {
				if (!sourceImg || !sourceImg.complete) return;
				
				const ctx = canvas.getContext("2d");
				canvas.width = width;
				canvas.height = height;
				ctx.clearRect(0, 0, width, height);

				const rotation = ((transform.rotate || 0) % 360 + 360) % 360;
				const flipX = transform.flipX || false;

				// Draw image directly with simple transform
				ctx.save();
				ctx.beginPath();
				ctx.rect(0, 0, width, height);
				ctx.clip();

				ctx.translate(width / 2, height / 2);
				ctx.scale(flipX ? -1 : 1, 1);
				ctx.rotate((rotation * Math.PI) / 180);

				const imgWidth = sourceImg.naturalWidth || sourceImg.width;
				const imgHeight = sourceImg.naturalHeight || sourceImg.height;
				
				// Scale to fit
				const ratio = Math.min(width / imgWidth, height / imgHeight);
				const drawWidth = imgWidth * ratio;
				const drawHeight = imgHeight * ratio;

				ctx.drawImage(sourceImg, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
				ctx.restore();
			}

			function populateMarquee(allFiles) {
				let todayFiles = allFiles.filter(f => isToday(f.createdTime));
				
				// If no files from today, show the most recent files
				if (todayFiles.length === 0) {
					todayFiles = allFiles.slice(0, 10);
				}
				
				marqueeEl.innerHTML = "";
				stopMarquee();

				if (todayFiles.length === 0) {
					return;
				}

				todayFiles.forEach((file) => {
					const item = document.createElement("div");
					item.className = "marquee-item";
					item.style.cursor = "pointer";

					const thumbUrl = file.thumbnailLink
						? buildSizedImageUrl(file.thumbnailLink, 280)
						: `https://drive.google.com/thumbnail?id=${file.id}&sz=w280`;

					const img = document.createElement("img");
					img.src = thumbUrl;
					img.alt = file.name || "Memory";
					img.style.width = "100%";
					img.style.height = "100%";
					img.style.objectFit = "cover";
					img.style.display = "block";

					item.appendChild(img);

					item.addEventListener("click", () => {
						const fullUrl = file.thumbnailLink
							? buildSizedImageUrl(file.thumbnailLink, 1600)
							: `https://drive.google.com/uc?export=view&id=${file.id}`;
						openModal(fullUrl);
					});

					marqueeEl.appendChild(item);
				});

				startMarquee();
			}

			const marqueeState = {
				offset: 0,
				speed: 0.75,
				rafId: null,
				paused: false,
			};

			marqueeEl.addEventListener("mouseenter", () => {
				marqueeState.paused = true;
			});
			marqueeEl.addEventListener("mouseleave", () => {
				marqueeState.paused = false;
			});

			function getMarqueeStepWidth() {
				const firstItem = marqueeEl.firstElementChild;
				if (!firstItem) {
					return 0;
				}
				const styles = window.getComputedStyle(marqueeEl);
				const gapValue = parseFloat(styles.gap || "0") || 0;
				return firstItem.getBoundingClientRect().width + gapValue;
			}

			function stepMarquee() {
				if (marqueeState.paused || !marqueeEl.children.length) {
					marqueeState.rafId = window.requestAnimationFrame(stepMarquee);
					return;
				}

				marqueeState.offset -= marqueeState.speed;
				const stepWidth = getMarqueeStepWidth();
				if (stepWidth > 0 && Math.abs(marqueeState.offset) >= stepWidth) {
					const first = marqueeEl.firstElementChild;
					if (first) {
						marqueeEl.appendChild(first);
						marqueeState.offset += stepWidth;
					}
				}

				marqueeEl.style.transform = `translateX(${marqueeState.offset}px)`;
				marqueeState.rafId = window.requestAnimationFrame(stepMarquee);
			}

			function startMarquee() {
				marqueeState.offset = 0;
				marqueeEl.style.transform = "translateX(0px)";
				if (marqueeState.rafId) {
					window.cancelAnimationFrame(marqueeState.rafId);
				}
				marqueeState.rafId = window.requestAnimationFrame(stepMarquee);
			}

			function stopMarquee() {
				if (marqueeState.rafId) {
					window.cancelAnimationFrame(marqueeState.rafId);
				}
				marqueeState.rafId = null;
				marqueeState.offset = 0;
				marqueeEl.style.transform = "translateX(0px)";
			}

			function debounce(fn, delay) {
				let timer;
				return (...args) => {
					window.clearTimeout(timer);
					timer = window.setTimeout(() => fn(...args), delay);
				};
			}

			async function initClient() {
				const apiKey = apiKeyInput.value.trim();
				const clientId = clientIdInput.value.trim();

				if (!apiKey || !clientId) {
					setStatus("Please provide both API Key and OAuth Client ID for private Drive access.");
					return;
				}

				setStatus("Initializing Google API client...");

				await gapi.client.init({
					apiKey,
					clientId,
					discoveryDocs: DISCOVERY_DOCS,
					scope: SCOPES,
				});

				isInitialized = true;
				const authInstance = gapi.auth2.getAuthInstance();
				authInstance.isSignedIn.listen(updateSigninStatus);
				updateSigninStatus(authInstance.isSignedIn.get());
			}

			function updateSigninStatus(signedIn) {
				isAuthorized = signedIn;
				setButtons();
				if (signedIn) {
					setStatus("Connected. Loading images...");
					listImages();
				} else {
					setStatus("Not connected.");
					clearGallery();
				}
			}

			async function handleConnect() {
				try {
					if (!isInitialized) {
						await new Promise((resolve, reject) => {
							gapi.load("client:auth2", {
								callback: resolve,
								onerror: () => reject(new Error("Failed to load Google API.")),
							});
						});
						await initClient();
					}

					const authInstance = gapi.auth2.getAuthInstance();
					if (!authInstance.isSignedIn.get()) {
						setStatus("Opening sign-in window...");
						await authInstance.signIn();
					} else {
						listImages();
					}
				} catch (error) {
					setStatus(`Error: ${error.message}`);
				}
			}

			async function handlePublicLoad() {
				const apiKey = (apiKeyInput.value.trim() || DEFAULT_API_KEY).trim();
				const folderId = folderIdInput.value.trim();
				if (!apiKey || !folderId) {
					setStatus("Provide API Key and Folder ID to load a public folder.");
					return;
				}

				clearGallery();
				clearSecondaryGallery();
				setStatus("Fetching public folder images...");

				const pageSize = Math.max(1, Math.min(500, Number(pageSizeInput.value) || 100));

				try {
					const [mainFiles, secondaryFiles] = await Promise.all([
						fetchDriveImages({
							apiKey,
							folderId,
							pageSize,
							orderBy: sortOrderSelect.value,
						}),
						fetchDriveImages({
							apiKey,
							folderId: SECONDARY_FOLDER_ID,
							pageSize,
							orderBy: sortOrderSelect.value,
						}),
					]);

					if (!mainFiles.length) {
						showEmptyState(true);
					}
					if (!secondaryFiles.length) {
						showSecondaryEmptyState(true);
					}

					renderFiles(mainFiles, galleryEl);
					renderFiles(secondaryFiles, gallerySecondaryEl);

					populateMarquee([...mainFiles, ...secondaryFiles]);

					setStatus(`Loaded ${mainFiles.length} main image(s) and ${secondaryFiles.length} from Rham's Faves.`);
				} catch (error) {
					setStatus(`Error fetching public images: ${error.message}`);
				}
			}

			async function handleSignOut() {
				const authInstance = gapi.auth2.getAuthInstance();
				await authInstance.signOut();
				updateSigninStatus(false);
			}

			async function listImages() {
				if (!isAuthorized) {
					return;
				}

				clearGallery();
				setStatus("Fetching images...");

				const folderId = folderIdInput.value.trim();
				const pageSize = Math.max(1, Math.min(500, Number(pageSizeInput.value) || 100));

				const baseQuery = "mimeType contains 'image/' and trashed = false";
				const q = folderId ? `'${folderId}' in parents and ${baseQuery}` : baseQuery;

				try {
					const response = await gapi.client.drive.files.list({
						q,
						pageSize,
						fields: "files(id,name,mimeType,thumbnailLink,webViewLink,createdTime)",
						orderBy: sortOrderSelect.value,
					});

					const files = response.result.files || [];
					if (!files.length) {
						showEmptyState(true);
						setStatus("No images found.");
						return;
					}

					files.forEach((file) => {
						const item = document.createElement("div");
						item.className = "gallery-item";

						const img = document.createElement("img");
						if (file.thumbnailLink) {
							img.src = file.thumbnailLink.replace("=s220", "=s640");
						} else {
							img.alt = "No preview available";
						}

						const meta = document.createElement("div");
						meta.className = "meta";

						const name = document.createElement("div");
						name.className = "name";
						name.textContent = file.name;

						const link = document.createElement("a");
						link.href = file.webViewLink;
						link.target = "_blank";
						link.rel = "noopener";
						link.textContent = "Open in Drive";

						meta.appendChild(name);
						meta.appendChild(link);
						item.appendChild(img);
						item.appendChild(meta);
						galleryEl.appendChild(item);
					});

					setStatus(`Loaded ${files.length} image(s).`);
					populateMarquee(files);
				} catch (error) {
					setStatus(`Error fetching images: ${error.message}`);
				}
			}

			const autoLoadPublic = debounce(() => {
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				}
			}, 600);

			connectBtn.addEventListener("click", handleConnect);
			publicBtn.addEventListener("click", handlePublicLoad);
			refreshBtn.addEventListener("click", listImages);
			signOutBtn.addEventListener("click", handleSignOut);
			apiKeyInput.addEventListener("input", autoLoadPublic);
			sortOrderSelect.addEventListener("change", () => {
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				} else if (isAuthorized) {
					listImages();
				}
			});

			window.addEventListener("load", () => {
				updateLoveCounter();
				window.setInterval(updateLoveCounter, 1000);
				if ((apiKeyInput.value.trim() || DEFAULT_API_KEY).trim()) {
					handlePublicLoad();
				}
			});

			[galleryEl, gallerySecondaryEl].forEach((gallery) => {
				gallery.addEventListener("click", (event) => {
					const img = event.target.closest("img");
					if (!img || !img.dataset.full) {
						return;
					}
					openModal(img.dataset.full);
				});
			});

			modalClose.addEventListener("click", closeModal);
			imageModal.addEventListener("click", (event) => {
				if (event.target === imageModal) {
					closeModal();
				}
			});

			window.addEventListener("keydown", (event) => {
				if (event.key === "Escape") {
					closeModal();
				}
			});
		</script>
	</body>
</html>
